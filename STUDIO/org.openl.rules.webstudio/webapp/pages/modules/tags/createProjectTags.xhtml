<?xml version="1.0" encoding="UTF-8"?>
<ui:composition
        xmlns:ui="http://java.sun.com/jsf/facelets"
        xmlns:h="http://java.sun.com/jsf/html"
        xmlns:f="http://java.sun.com/jsf/core"
        xmlns:a4j="http://richfaces.org/a4j"
        xmlns:rich="http://richfaces.org/rich">

    <rich:popupPanel id="modalCreateProjectTags" minWidth="330" autosized="true">
        <f:facet name="header">
            <h:outputText value="Tags"/>
        </f:facet>

        <f:facet name="controls">
            <h:graphicImage value="/images/close.gif" class="close"
                            onclick="hideCreateProjectTags()" alt="Close"/>
        </f:facet>

        <h:form id="createProjectTagsForm">
            <div>
                <table class="formfields">
                    <ui:repeat value="#{repositoryTreeController.tags}" var="tag">
                        <tr>
                            <td>
                                <h:inputHidden value="#{tag.id}"/>
                                <label><h:outputText value="#{tag.type.name}:"/></label>
                            </td>
                            <td>
                                <h:selectOneMenu id="tagSelection" value="#{tag.id}" hideNoSelectionOption="true">
                                    <f:ajax event="change" render="tagSelection"/>
                                    <f:selectItem itemLabel="[None]" itemValue="-1"
                                                  itemDisabled="#{not tag.type.nullable}"
                                                  noSelectionOption="#{not tag.type.nullable}"/>
                                    <f:selectItems value="#{projectTagsBean.getTagValues(tag.type.name)}" var="t"
                                                   itemValue="#{t.id}" itemLabel="#{t.name}"/>
                                </h:selectOneMenu>
                            </td>
                            <td>
                                <h:panelGroup rendered="#{tag.type.extensible}">
                                    <span class="clickable" onclick="createTagValue('#{utils.toJSText(tag.type.name)}', renderCreateProjectTagsForm)" title="Add tag">
                                        +
                                    </span>
                                </h:panelGroup>
                            </td>
                        </tr>
                    </ui:repeat>

                </table>
            </div>

            <footer>
                <a4j:commandButton value="Save" data="#{facesContext.maximumSeverity}"
                                   oncomplete="if(!event.data) {hideCreateProjectTags(); submitForm();}" render="nodeView"
                                   styleClass="button-primary"/>
                <input type="button" value="Cancel" onclick="hideCreateProjectTags()"/>
            </footer>

            <a4j:jsFunction name="renderCreateProjectTagsForm" render="@form"/>
            <a4j:jsFunction name="initCreateProjectTagsDialog" action="#{projectTagsBean.init}" render="@form" oncomplete="showCreateProjectTagsDialog();"/>

        </h:form>

    </rich:popupPanel>

    <script>
        //<![CDATA[
        let submitForm = function () {};

        function createProjectTags(submitFormFunction) {
            submitForm = submitFormFunction;
            initCreateProjectTagsDialog();
        }

        function showCreateProjectTagsDialog() {
            RichFaces.$('modalCreateProjectTags').show();
        }

        function hideCreateProjectTags() {
            RichFaces.$("modalCreateProjectTags").hide();

            // Reset form
            $j("#createProjectTagsForm")[0].reset();
        }

        //]]>
    </script>

</ui:composition>
