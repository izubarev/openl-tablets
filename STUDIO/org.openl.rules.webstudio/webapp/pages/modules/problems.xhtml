<ui:composition
        xmlns="http://www.w3.org/1999/xhtml"
        xmlns:c="http://java.sun.com/jsp/jstl/core"
        xmlns:ui="http://java.sun.com/jsf/facelets">

    <c:set var="contextPath" value="#{facesContext.externalContext.request.contextPath}" />

    <style>
        .messagePanel {
            float: left;
            margin-left:15px;
        }

        .messagePanelHolder{
            overflow: auto;
            margin-bottom:15px;
        }
    </style>

    <div class="panel">
        <div class="panel-header container" style="padding-left: 24px">
            <span>#{msg['ws.problems']}</span>
        </div>

        <div class="panel-body container">
            <div class="messagePanelHolder">
                <div id="progressInfoPanel" class='messagePanel'/>
                <div id="errorsInfoPanel" class='messagePanel'>Errors:
                    <span id="errorsCount" class='badge badge-error'/>
                </div>
                <div id="warningsInfoPanel" class='messagePanel'>Warnings:
                    <span id="warningsCount" class='badge badge-warning'/>
                </div>
            </div>
            <div id="errorsPanel"></div>
            <div id="warningsPanel"></div>

            <script>
                //<![CDATA[
                var $jq = jQuery.noConflict();
                var messageId = -1;
                var messageIndex = -1;

                $jq('#progressInfoPanel').bind('refresh', function () {
                    $jq.ajax({
                        url: "#{contextPath}/web/compile/progress/" + messageId + "/" + messageIndex,
                        datatype: "text"
                    })
                        .done(function (data) {
                            $jq('#progressInfoPanel').text(Math.round(data.modulesCompiled / data.modulesCount * 100) + "% (" + data.modulesCompiled + "/" + data.modulesCount + ") completed");

                            $jq('#errorsInfoPanel').toggle(data.errorsCount !== 0);
                            $jq('#errorsCount').text(data.errorsCount);

                            $jq('#warningsInfoPanel').toggle(data.warningsCount !== 0);
                            $jq('#warningsCount').text(data.warningsCount);

                            if (data.messageIndex !== -1 || data.messageId !== -1) {
                                messageIndex = data.messageIndex;
                                messageId = data.messageId;
                            }

                            if (data.messages.length !== 0) {
                                var warningsPanel = document.getElementById("warningsPanel");
                                var errorsPanel = document.getElementById("errorsPanel");
                                var warningsHtml = "";
                                var errorsHtml = "";

                                data.messages.forEach(function (item) {
                                    if (item.severity === 'WARN') {
                                        warningsHtml +=
                                            "<div><a href = " + item.url + " title class='problem-warning problem-small' style='color: black; text-decoration:none;'>" + item.summary + "</a></div>";
                                    } else if (item.severity === 'ERROR') {
                                        errorsHtml +=
                                            "<div><a href = " + item.url + " title class='problem-error problem-small' style='color: black; text-decoration:none;'>" + item.summary + "</a></div>";
                                    }
                                });

                                var warningsDiv = document.createElement("DIV");
                                var errorsDiv = document.createElement("DIV");

                                if (data.dataType === 'new') {
                                    while(warningsPanel.firstChild) warningsPanel.removeChild(warningsPanel.firstChild);
                                    while(errorsPanel.firstChild) errorsPanel.removeChild(errorsPanel.firstChild);
                                    warningsDiv.innerHTML = warningsHtml;
                                    errorsDiv.innerHTML = errorsHtml;
                                } else {
                                    warningsDiv.innerHTML += warningsHtml;
                                    errorsDiv.innerHTML += errorsHtml;
                                }

                                warningsPanel.appendChild(warningsDiv);
                                errorsPanel.appendChild(errorsDiv);
                            }
                            setTimeout(function () {$jq('#progressInfoPanel').trigger('refresh')}, 1000);
                        });
                });

                $jq('#progressInfoPanel').trigger('refresh');

                //]]>
            </script>
        </div>
    </div>

</ui:composition>
