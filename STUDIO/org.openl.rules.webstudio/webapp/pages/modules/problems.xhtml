<ui:composition
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:ui="http://java.sun.com/jsf/facelets">

    <style>
        .messagePanel {
            float: left;
            margin-left:15px;
        }

        .messagePanelHolder{
            overflow: auto;
            margin-bottom:15px;
        }
    </style>

    <div class="panel">
        <div class="panel-header container" style="padding-left: 24px">
            <span>#{msg['ws.problems']}</span>
        </div>

        <div class="panel-body container">
            <div id="progressInfoPanel"/>
            <div id="errorsPanel"></div>
            <div id="warningsPanel"></div>

            <script>
                //<![CDATA[
                var $jq = jQuery.noConflict();
                var messageId = -1;
                var messageIndex = -1;

                $jq('#progressInfoPanel').bind('refresh', function (e) {
                    $jq.ajax({
                        url: "#{contextPath}/webstudio/web/compile/progress/" + messageId + "/" + messageIndex,
                        datatype: "text"
                    })
                        .done(function (data) {
                            // $jq('#progressInfoPanel').toggle(true);
                            //jq toggle id true false
                            var infoPanel = document.getElementById("progressInfoPanel");
                            var progressHtml = "<div class='messagePanelHolder'><div class='messagePanel'>" + Math.round(data.modulesCompiled / data.modulesCount * 100) + "% (" + data.modulesCompiled +
                                "/" + data.modulesCount + ") compiled</div>";
                            if (data.errorsCount !== 0) {
                                progressHtml += "<div class='messagePanel'> Errors: <span class='badge badge-error'>" + data.errorsCount + "</span></div>";
                            }
                            if (data.warningsCount !== 0) {
                                progressHtml += "<div class='messagePanel'> Warnings: <span class='badge badge-small badge-warning'>" + data.warningsCount + "</span></div>";
                            }
                            progressHtml += "</div>";
                            var progressDiv = document.createElement("DIV");
                            progressDiv.innerHTML = progressHtml;
                            if (infoPanel.firstChild) {
                                infoPanel.removeChild(infoPanel.firstChild);
                            }
                            infoPanel.appendChild(progressDiv);

                            if (data.messageIndex !== -1 && data.messageId !== -1) {
                                messageIndex = data.messageIndex;
                                messageId = data.messageId;
                            }

                            if (data.messages.length !== 0) {
                                var warningsPanel = document.getElementById("warningsPanel");
                                var errorsPanel = document.getElementById("errorsPanel");
                                var warningsHtml = "";
                                var errorsHtml = "";

                                data.messages.forEach(function (item) {
                                    if (item.severity === 'WARN') {
                                        warningsHtml +=
                                            "<div><a href = " + item.url + " title class='problem-warning problem-small' style='color: black; text-decoration:none;'>" + item.summary + "</a></div>";
                                    } else if (item.severity === 'ERROR') {
                                        errorsHtml +=
                                            "<div><a href = " + item.url + " title class='problem-error problem-small' style='color: black; text-decoration:none;'>" + item.summary + "</a></div>";
                                    }
                                });

                                var warningsDiv = document.createElement("DIV");
                                var errorsDiv = document.createElement("DIV");

                                if (data.dataType === 'new') {
                                    warningsDiv.innerHTML = warningsHtml;
                                    errorsDiv.innerHTML = errorsHtml;
                                } else {
                                    warningsDiv.innerHTML += warningsHtml;
                                    errorsDiv.innerHTML += errorsHtml;
                                }

                                warningsPanel.appendChild(warningsDiv);
                                errorsPanel.appendChild(errorsDiv);
                            }
                        });
                });

                $jq('#progressInfoPanel').trigger('refresh');
                setInterval(function () {$jq('#progressInfoPanel').trigger('refresh')}, 1000);//time in milliseconds

                //]]>
            </script>
        </div>
    </div>

</ui:composition>
