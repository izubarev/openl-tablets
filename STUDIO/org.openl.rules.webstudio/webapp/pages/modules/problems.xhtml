<ui:composition
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:ui="http://java.sun.com/jsf/facelets">

    <style>
        .tree-problems .rf-trn-ico {
            display: none;
        }

    </style>

    <div class="panel">
        <div class="panel-header container" style="padding-left: 24px">
            <span>#{msg['ws.problems']}</span>
        </div>

        <div class="panel-body container">
            <div id="infoPanel"/>
            <div id="errorsPanel"></div>
            <div id="warningsPanel"></div>

            <script>
                //<![CDATA[
                var $jq = jQuery.noConflict();
                var messageId = -1;
                var messageIndex = -1;

                $jq('#infoPanel').bind('refresh', function (e) {
                    $jq.ajax({
                        url: "#{contextPath}/webstudio/web/compile/progress/" + messageId + "/" + messageIndex,
                        datatype: "text"
                    })
                        .done(function (data) {
                            var box = $jq(e.target);
                            box.text(Math.round(data.modulesCompiled / data.modulesCount * 100) + "% completed");
                            messageIndex = data.messageIndex;
                            messageId = data.messageId;

                            var warningsPanel = document.getElementById("warningsPanel");
                            var errorsPanel = document.getElementById("errorsPanel");
                            var warningsHtml = "";
                            var errorsHtml = "";

                            data.messages.forEach(function (item) {
                                if (item.severity === 'WARN') {
                                    warningsHtml +=
                                        "<a href = "+item.url+" title class='problem-warning problem-small'>"+item.summary+"</a>";
                                } else if(item.severity === 'ERROR') {
                                    errorsHtml +=
                                        "<a href = "+item.url+" title class='problem-error problem-small'>"+item.summary+"</a>";
                                }
                            });

                            var warningsDiv = document.createElement("DIV");
                            var errorsDiv = document.createElement("DIV");

                            if (data.dataType === 'new') {
                                warningsDiv.innerHTML = warningsHtml;
                                errorsDiv.innerHTML = errorsHtml;
                            } else {
                                warningsDiv.innerHTML += warningsHtml;
                                errorsDiv.innerHTML += errorsHtml;
                            }

                            warningsPanel.appendChild(warningsDiv);
                            errorsPanel.appendChild(errorsDiv);
                        });
                });

                $jq('#infoPanel').trigger('refresh');
                setInterval(function () {$jq('#infoPanel').trigger('refresh')}, 1000);//time in milliseconds

                //]]>
            </script>
        </div>
    </div>

</ui:composition>
